<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>CE edit form</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma"        content="no-cache" />
  <meta http-equiv="Expires"       content="0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>#stickyBar { position: sticky; top: 0; z-index: 50; }</style>
</head>
<body class="bg-gray-100">
  <!-- STICKY BAR -->
  <div id="stickyBar" class="flex items-center justify-between bg-blue-600 p-4">
    <h1 class="text-lg font-semibold text-white">CE edit form</h1>
    <div class="space-x-2">
      <button id="addFeedbackBtn"
              class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded">
        Thêm feedback
      </button>
      <button id="noFeedbackBtn"
              class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">
        Checked no feedback
      </button>
      <button id="saveBtn"
              class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">
        Save
      </button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="max-w-3xl mx-auto p-6 space-y-6">

    <!-- Information -->
    <section class="border rounded bg-gray-50 p-4">
      <h2 class="font-semibold text-gray-700 mb-4">Information</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">

        <div>
          <label class="block">Owner name</label>
          <input id="ownerName" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">ID</label>
          <input id="idField" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Tracking</label>
          <input id="tracking" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Tracking CR</label>
          <input id="trackingCR" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Type</label>
          <span id="typeBadge" class="inline-block w-full rounded p-2 bg-gray-200"></span>
        </div>

        <div>
          <label class="block">Description</label>
          <textarea id="description" rows="2"
                    class="w-full bg-gray-200 rounded p-2" readonly></textarea>
        </div>

        <div>
          <label class="block">Video OB</label>
          <div id="videoOBBox" class="w-full bg-gray-200 rounded p-2"></div>
        </div>

        <div>
          <label class="block">Date received (dd/mm/yyyy)</label>
          <input id="dateReceivedTxt" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Aging backlog</label>
          <span id="agingBadge" class="inline-block w-full rounded p-2 bg-gray-200"></span>
        </div>

      </div>
    </section>

    <!-- Status -->
    <section class="border rounded bg-white p-4">
      <h2 class="font-semibold text-gray-700 mb-4">Status</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">

        <div>
          <label class="block">Brief case</label>
          <input id="briefCase" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Created date (dd/mm/yyyy)</label>
          <input id="createdDate" class="w-full border rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Final date (dd/mm/yyyy)</label>
          <input id="finalDate" class="w-full border rounded p-2" readonly />
        </div>

        <div class="col-span-2">
          <label class="block">CE Status</label>
          <select id="ceStatus" class="w-full border rounded p-2">
            <option value="">— Chọn trạng thái —</option>
            <option>Created</option>
            <option>Being process</option>
            <option>Appeal success</option>
            <option>Appeal reject</option>
            <option>Do not claim</option>
            <option>Need to follow</option>
            <option>Closed</option>
          </select>
        </div>

        <div>
          <label class="block">Reason dispute</label>
          <textarea id="reasonDispute" rows="2" class="w-full border rounded p-2"></textarea>
        </div>

        <div>
          <label class="block">Feedback count</label>
          <input type="number" id="feedbackCount" min="0" class="w-full border rounded p-2" />
        </div>

        <div>
          <label class="block">Last feedback </label>
          <input id="lastFeedback" class="w-full border rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Last checked</label>
          <input id="lastChecked" class="w-full border rounded p-2" readonly />
        </div>

      </div>
    </section>
  </div>

  <script>
    // Hàm chuẩn hóa ngày về dd/mm/yyyy
    function toDisplayDate(s) {
      if (!s) return '';
      if (typeof s === 'string') {
        let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) return `${m[3]}/${m[2]}/${m[1]}`;
        if (s.match(/^\d{2}\/\d{2}\/\d{4}$/)) return s;
      }
      if (s instanceof Date && !isNaN(s)) {
        const d = s;
        return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
      }
      return s;
    }

    function toInputDate(s) {
      if (!s) return '';
      if (typeof s === 'string') {
        let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) return `${m[1]}-${m[2]}-${m[3]}`;
        if (s.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
          const [d, mth, y] = s.split('/');
          return `${y}-${mth.padStart(2,'0')}-${d.padStart(2,'0')}`;
        }
      }
      if (s instanceof Date && !isNaN(s)) return s.toISOString().slice(0,10);
      return '';
    }

    // ==== Load item từ sessionStorage ====
    const raw   = sessionStorage.getItem('editItem');
    if (!raw) { alert('Không tìm thấy dữ liệu'); window.close(); }
    const item  = JSON.parse(raw);
    const orig  = {};

    // --- Fill Information ---
    document.getElementById('ownerName').value    = item['Owner name'] || '';
    document.getElementById('idField').value      = item.ID || '';
    document.getElementById('tracking').value     = item.Tracking || '';
    document.getElementById('trackingCR').value   = item['Tracking CR'] || '';
    document.getElementById('description').value  = item.Description || '';

    // Type badge
    const typeEl = document.getElementById('typeBadge');
    if (item.Type === 'CR')    { typeEl.textContent = 'CR'; typeEl.classList.add('text-red-600'); }
    else if (item.Type === 'FD'){ typeEl.textContent = 'FD'; typeEl.classList.add('text-green-600'); }
    else                        typeEl.textContent = item.Type || '';

    // Video OB
    const vBox = document.getElementById('videoOBBox');
    if (item['Video OB']) {
      const linkBtn = document.createElement('button');
      linkBtn.textContent = 'Copy link';
      linkBtn.className = 'text-blue-600 underline';
      linkBtn.onclick  = () => navigator.clipboard.writeText(item['Video OB']);
      vBox.appendChild(linkBtn);
    } else vBox.textContent = 'Chưa update';

    // Date received & aging
    const dateReceivedDisp = toDisplayDate(item['Date received']);
    document.getElementById('dateReceivedTxt').value = dateReceivedDisp;

    // Tính aging backlog (now - date received)
    let aging = '';
    if (dateReceivedDisp) {
      const dateReceivedISO = toInputDate(dateReceivedDisp);
      const recvDate = new Date(dateReceivedISO);
      const now = new Date();
      if (!isNaN(recvDate)) {
        recvDate.setHours(0,0,0,0); now.setHours(0,0,0,0);
        aging = Math.floor((now - recvDate) / 86400000);
      }
    }
    document.getElementById('agingBadge').textContent = aging !== '' ? `${aging} ngày` : '';

    // --- Fill Status ---
    document.getElementById('briefCase').value      = item['Brief case'] || '';
    document.getElementById('createdDate').value    = toDisplayDate(item['Created date']);
    document.getElementById('finalDate').value      = toDisplayDate(item['Final date']);
    document.getElementById('ceStatus').value       = item['CE Status'] || '';
    document.getElementById('reasonDispute').value  = item['Reason dispute'] || '';
    document.getElementById('feedbackCount').value  = item['Feedback count'] || '';
    document.getElementById('lastFeedback').value   = toDisplayDate(item['Last feedback']);
    document.getElementById('lastChecked').value    = toDisplayDate(item['Last checked']);

    // Lưu orig để kiểm tra thay đổi
    orig['Created date']    = document.getElementById('createdDate').value;
    orig['Final date']      = document.getElementById('finalDate').value;
    orig['CE Status']       = document.getElementById('ceStatus').value;
    orig['Reason dispute']  = document.getElementById('reasonDispute').value;
    orig['Feedback count']  = document.getElementById('feedbackCount').value;
    orig['Last feedback']   = document.getElementById('lastFeedback').value;

    // ===== CE Status cập nhật ngày =====
    const ceStatusEl = document.getElementById('ceStatus');
    const createdDateEl = document.getElementById('createdDate');
    const finalDateEl = document.getElementById('finalDate');
    ceStatusEl.addEventListener('change', function() {
      const nowDDMMYYYY = toDisplayDate(new Date());
      if (this.value === 'Created') {
        createdDateEl.value = nowDDMMYYYY;
      }
    });

    // ======= THÊM FEEDBACK =======
    document.getElementById('addFeedbackBtn').addEventListener('click', async () => {
      const ceStatusEl = document.getElementById('ceStatus');
      const feedbackCountEl = document.getElementById('feedbackCount');
      const lastFeedbackEl = document.getElementById('lastFeedback');
      let ceStatus = ceStatusEl.value;
      let feedbackCount = parseInt(feedbackCountEl.value) || 0;

      // Chỉ chấp nhận khi status là Created hoặc Being process
      if (ceStatus !== 'Created' && ceStatus !== 'Being process') {
        alert('Không hợp lệ, case chưa có status hoặc đang đóng!');
        return;
      }

      const todayDisplay = toDisplayDate(new Date());

      if (ceStatus === 'Created') {
        ceStatus = 'Being process';
        ceStatusEl.value = ceStatus;
        feedbackCount = 2;
      } else if (ceStatus === 'Being process') {
        feedbackCount += 1;
      }

      feedbackCountEl.value = feedbackCount;
      lastFeedbackEl.value = todayDisplay;

      // Tự động lưu lên server luôn:
      const payload = { ...item };
      payload['CE Status'] = ceStatus;
      payload['Feedback count'] = feedbackCount;
      payload['Last feedback'] = todayDisplay;

      await pushToSheet(payload);
      window.opener.postMessage(payload, '*');
      sessionStorage.removeItem('editItem');
      window.close();
    });


    // ===== Checked no feedback =====
    document.getElementById('noFeedbackBtn').addEventListener('click', async () => {
      // Lấy giá trị hiện tại của các ô trong Status
      const curr = {
        'Created date':     document.getElementById('createdDate').value,
        'Final date':       document.getElementById('finalDate').value,
        'CE Status':        document.getElementById('ceStatus').value,
        'Reason dispute':   document.getElementById('reasonDispute').value,
        'Feedback count':   document.getElementById('feedbackCount').value,
        'Last feedback':    document.getElementById('lastFeedback').value
      };
      // Kiểm tra thay đổi
      const isChanged = Object.keys(curr).some(k => curr[k] !== orig[k]);
      if (isChanged) {
        if (confirm('Bạn đã change data, nếu bạn đồng ý bỏ data đã change chỉ update ngày last checked thì hãy nhấn đồng ý')) {
          // Chỉ update Last checked
          const today = new Date().toISOString().slice(0,10);
          const payload = { ...item };
          payload['Last checked'] = today;
          await pushToSheet(payload);
          window.opener.postMessage(payload, '*');
          sessionStorage.removeItem('editItem');
          window.close();
          return;
        } else {
          // Cancel thì không làm gì cả
          return;
        }
      } else {
        // Không thay đổi gì, thì vẫn update last checked và date received
        const today = new Date().toISOString().slice(0,10);
        const payload = { ...item };
        payload['Last checked'] = today;
        payload['Date received'] = today;
        await pushToSheet(payload);
        window.opener.postMessage(payload, '*');
        sessionStorage.removeItem('editItem');
        window.close();
      }
    });

    // ===== SAVE =====
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const ceStatus = document.getElementById('ceStatus').value;
      const reasonDispute = document.getElementById('reasonDispute').value.trim();
      const finalDateEl = document.getElementById('finalDate');
      const nowDDMMYYYY = toDisplayDate(new Date());
    
      // Nếu CE Status là "Appeal success", "Appeal reject", "Do not claim", cập nhật final date = today
      if (
        ceStatus === 'Appeal success' ||
        ceStatus === 'Appeal reject' ||
        ceStatus === 'Do not claim'
      ) {
        finalDateEl.value = nowDDMMYYYY;
      }
    
      // Nếu CE Status là "Appeal reject" hoặc "Do not claim" thì reason dispute không được để trống
      if (
        (ceStatus === "Appeal reject" || ceStatus === "Do not claim") &&
        reasonDispute === ""
      ) {
        alert("Cập nhật reason dispute");
        document.getElementById('reasonDispute').focus();
        return;
      }
    
      const payload = { ...item };
      payload['Created date']     = document.getElementById('createdDate').value;
      payload['Final date']       = document.getElementById('finalDate').value;
      payload['CE Status']        = ceStatus;
      payload['Reason dispute']   = reasonDispute;
      payload['Feedback count']   = document.getElementById('feedbackCount').value;
      payload['Last feedback']    = toDisplayDate(document.getElementById('lastFeedback').value);
      payload['Last checked']     = toDisplayDate(document.getElementById('lastChecked').value);
    
      await pushToSheet(payload);
      window.opener.postMessage(payload, '*');
      sessionStorage.removeItem('editItem');
      window.close();
    });
    // ===== Push cập nhật lên server =====
    async function pushToSheet(obj) {
      if (!obj._row || obj._row === 0) {
        alert('Dữ liệu không chứa giá trị _row hợp lệ!');
        return;
      }
      const res = await fetch('https://lzdcemanagement.phuonghoangcao1703.workers.dev/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(obj)
      });
      if (!res.ok) {
        const t = await res.text();
        alert('Không thể cập nhật Google Sheet: ' + t);
        throw new Error(t);
      }
    }
  </script>
</body>
</html>


