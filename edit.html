<!-- ✨ CE edit form – 2025-08-03 -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>CE edit form</title>

  <!-- Force fresh copy on GitHub Pages & browser -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma"        content="no-cache" />
  <meta http-equiv="Expires"       content="0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Giữ header + nút luôn hiển thị */
    #stickyBar { position: sticky; top: 0; z-index: 50; }
  </style>
</head>
<body class="bg-gray-100">
  <!-- STICKY BAR -->
  <div id="stickyBar" class="flex items-center justify-between bg-blue-600 p-4">
    <h1 class="text-lg font-semibold text-white">CE edit form</h1>
    <div class="space-x-2">
      <button id="noFeedbackBtn"
              class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">
        Checked no feedback
      </button>
      <button id="saveBtn"
              class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">
        Save
      </button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="max-w-3xl mx-auto p-6 space-y-6">

    <!-- Information -->
    <section class="border rounded bg-gray-50 p-4">
      <h2 class="font-semibold text-gray-700 mb-4">Information</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">

        <div>
          <label class="block">Owner name</label>
          <input id="ownerName" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">ID</label>
          <input id="idField" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Tracking</label>
          <input id="tracking" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Tracking CR</label>
          <input id="trackingCR" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Type</label>
          <span id="typeBadge" class="inline-block w-full rounded p-2 bg-gray-200"></span>
        </div>

        <div>
          <label class="block">Description</label>
          <textarea id="description" rows="2"
                    class="w-full bg-gray-200 rounded p-2" readonly></textarea>
        </div>

        <div>
          <label class="block">Video OB</label>
          <div id="videoOBBox" class="w-full bg-gray-200 rounded p-2"></div>
        </div>

        <div>
          <label class="block">Date received (dd/mm/yyyy)</label>
          <input id="dateReceivedTxt"
                 class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Aging backlog</label>
          <span id="agingBadge" class="inline-block w-full rounded p-2 bg-gray-200"></span>
        </div>

      </div>
    </section>

    <!-- Status -->
    <section class="border rounded bg-white p-4">
      <h2 class="font-semibold text-gray-700 mb-4">Status</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">

        <div>
          <label class="block">Brief case</label>
          <input id="briefCase" class="w-full bg-gray-200 rounded p-2" readonly />
        </div>

        <div>
          <label class="block">Created date</label>
          <input type="date" id="createdDate" class="w-full border rounded p-2" />
        </div>

        <div>
          <label class="block">Final date</label>
          <input type="date" id="finalDate" class="w-full border rounded p-2" />
        </div>

        <div class="col-span-2">
          <label class="block">CE Status</label>
          <select id="ceStatus" class="w-full border rounded p-2">
            <option value="">— Chọn trạng thái —</option>
            <option>Created</option>
            <option>Being process</option>
            <option>Appeal success</option>
            <option>Appeal reject</option>
            <option>Do not claim</option>
            <option>Need to follow</option>
            <option>Closed</option>
          </select>
        </div>

        <div>
          <label class="block">Reason dispute</label>
          <textarea id="reasonDispute" rows="2" class="w-full border rounded p-2"></textarea>
        </div>

        <div>
          <label class="block">Feedback count</label>
          <input type="number" id="feedbackCount" min="0" class="w-full border rounded p-2" />
        </div>

        <div>
          <label class="block">Last feedback </label>
          <input type="date" id="lastFeedback" class="w-full border rounded p-2" />
        </div>

        <div>
          <label class="block">Last checked</label>
          <input type="date" id="lastChecked" class="w-full border rounded p-2" />
        </div>

      </div>
    </section>
  </div>

  <script>
    /***** Helpers *****/
  const toInputDate = s => {
  if (!s) return '';
  if (typeof s === 'string') {
    // Nếu là ISO date dạng 2025-05-22T17:00:00.000Z
    if (s.match(/^\d{4}-\d{2}-\d{2}T/)) {
      // Cắt lấy phần yyyy-mm-dd
      return s.slice(0,10);
    }
    // Nếu chuỗi có "/", giả sử DD/MM/YYYY
    if (s.includes('/')) {
      const [d,m,y] = s.split('/');
      return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
    // Nếu đã là yyyy-mm-dd
    if (s.match(/^\d{4}-\d{2}-\d{2}$/)) {
      return s;
    }
  }
  // Nếu là Date object
  if (s instanceof Date && !isNaN(s)) {
    return s.toISOString().slice(0,10);
  }
  return '';
};
    const toDisplayDate = s => {
      if (!s) return '';
      // nếu đã yyyy-mm-dd, chuyển ngược lại
      if (s.includes('-')) {
        const [y,m,d] = s.split('-');
        return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
      }
      return s; // đã DD/MM/YYYY
    };

    /***** Load item từ sessionStorage *****/
    const raw   = sessionStorage.getItem('editItem');
    if (!raw) { alert('Không tìm thấy dữ liệu'); window.close(); }
    const item  = JSON.parse(raw);
    const orig  = {};   // Lưu giá trị gốc để so sánh

    // --- Fill Information ---
    document.getElementById('ownerName').value    = item['Owner name'] || '';
    document.getElementById('idField').value      = item.ID || '';
    document.getElementById('tracking').value     = item.Tracking || '';
    document.getElementById('trackingCR').value   = item['Tracking CR'] || '';
    document.getElementById('description').value  = item.Description || '';

    // Type badge
    const typeEl = document.getElementById('typeBadge');
    if (item.Type === 'CR')    { typeEl.textContent = 'CR'; typeEl.classList.add('text-red-600'); }
    else if (item.Type === 'FD'){ typeEl.textContent = 'FD'; typeEl.classList.add('text-green-600'); }
    else                        typeEl.textContent = item.Type || '';

    // Video OB
    const vBox = document.getElementById('videoOBBox');
    if (item['Video OB']) {
      const linkBtn = document.createElement('button');
      linkBtn.textContent = 'Copy link';
      linkBtn.className = 'text-blue-600 underline';
      linkBtn.onclick  = () => navigator.clipboard.writeText(item['Video OB']);
      vBox.appendChild(linkBtn);
    } else vBox.textContent = 'Chưa update';

    // Date received & aging
    function toDisplayDate(s) {
  if (!s) return '';
  if (typeof s === 'string') {
    // ISO dạng 2025-05-22T...
    let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) return `${m[3]}/${m[2]}/${m[1]}`;
    // yyyy-mm-dd
    m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m) return `${m[3]}/${m[2]}/${m[1]}`;
    // dd/mm/yyyy (đã đúng chuẩn)
    if (s.match(/^\d{2}\/\d{2}\/\d{4}$/)) return s;
  }
  // Nếu là đối tượng Date
  if (s instanceof Date && !isNaN(s)) {
    const d = s;
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
  }
  return s;
}
    document.getElementById('dateReceivedTxt').value = toDisplayDate(item['Date received']);

    const recvDate = new Date(toInputDate(drDisp));
    const days = isNaN(recvDate) ? 0 :
                 Math.floor((Date.now() - recvDate.getTime()) / 86400000);
    document.getElementById('agingBadge').textContent = `${days} ngày`;

    // --- Fill Status ---
    const set = (id, val) => document.getElementById(id).value = val || '';
    set('briefCase',        item['Brief case']);
    set('createdDate',      toInputDate(item['Created date']));
    set('finalDate',        toInputDate(item['Final date']));
    set('ceStatus',         item['CE Status']);
    set('reasonDispute',    item['Reason dispute']);
    set('feedbackCount',    item['Feedback count']);
    set('lastFeedback', toInputDate(item['Last feedback']));
    set('lastChecked',  toInputDate(item['Last checked']));

    // Lưu orig
    ['Created date','Final date','CE Status',
     'Reason dispute','Feedback count','Last checked'
    ].forEach(k => orig[k] = item[k] || '');

    /***** Checked no feedback *****/
    document.getElementById('noFeedbackBtn').addEventListener('click', async () => {
  const curr = {
    'Created date':      document.getElementById('createdDate').value,
    'Final date':        document.getElementById('finalDate').value,
    'CE Status':         document.getElementById('ceStatus').value,
    'Reason dispute':    document.getElementById('reasonDispute').value,
    'Feedback count':    document.getElementById('feedbackCount').value,
    'Last checked date': document.getElementById('lastChecked').value
  };

  const isChanged = Object.keys(curr).some(k => toDisplayDate(curr[k]) !== orig[k]);
  const today = new Date().toISOString().slice(0,10);
  const payload = { ...item };  // sao chép toàn bộ item gốc

  payload['Last checked'] = today;

  if (!isChanged) {
    // Nếu không có gì thay đổi, ta sẽ gán thêm Date received = today
    payload['Date received'] = today;
  } else {
    const ok = confirm('Bạn đã change data, bạn có muốn bỏ qua data đã change và chỉ cập nhật Last checked không?');
    if (!ok) return;
  }

  await pushToSheet(payload);
  window.opener.postMessage(payload, '*');
  sessionStorage.removeItem('editItem');
  window.close();
});


    /***** SAVE *****/
    document.getElementById('saveBtn').addEventListener('click', async () => {
  const payload = { ...item };  // sao chép toàn bộ dữ liệu gốc

  // Cập nhật lại các field có thể chỉnh sửa
  payload['Created date']       = toDisplayDate(document.getElementById('createdDate').value);
  payload['Final date']         = toDisplayDate(document.getElementById('finalDate').value);
  payload['CE Status']          = document.getElementById('ceStatus').value;
  payload['Reason dispute']     = document.getElementById('reasonDispute').value;
  payload['Feedback count']     = document.getElementById('feedbackCount').value;
  payload['Last feedback'] = toDisplayDate(document.getElementById('lastFeedback').value);
  payload['Last checked']  = toDisplayDate(document.getElementById('lastChecked').value);

  await pushToSheet(payload);
  window.opener.postMessage(payload, '*');
  sessionStorage.removeItem('editItem');
  window.close();
});


    /***** Gửi cập nhật đến Cloudflare Worker *****/
    async function pushToSheet(obj) {
  // Kiểm tra giá trị _row trước khi gửi
  if (!obj._row || obj._row === 0) {
    alert('Dữ liệu không chứa giá trị _row hợp lệ!');
    return;
  }

  // Gửi request cập nhật tới Cloudflare Worker
  const res = await fetch('https://lzdcemanagement.phuonghoangcao1703.workers.dev/update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(obj)
  });

  if (!res.ok) {
    const t = await res.text();
    alert('Không thể cập nhật Google Sheet: ' + t);
    throw new Error(t);
  }
}
  </script>
</body>
</html>







