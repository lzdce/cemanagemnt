<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>CE MANAGEMENT</title>

  <!-- ========== üëó CSS ========== -->
  <style>
    /* Page */
    body{
      font-family:'Segoe UI',sans-serif;
      margin:40px;
      background:#f4f6f8;
      color:#333;
    }

    h2{margin-bottom:16px;}

    /* Search */
    input[type="text"]{
      padding:10px 14px;
      width:300px;
      font-size:15px;
      border:1px solid #ccc;
      border-radius:6px;
      margin-bottom:20px;
    }

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:8px;
      overflow:hidden;
      box-shadow:0 1px 3px rgba(0,0,0,.05);
    }
    th,td{
      padding:12px 14px;
      border-bottom:1px solid #eee;
      text-align:left;
    }
    th{
      background:#f0f2f5;
      font-weight:600;
    }
    tr:hover{background:#fafafa;}

    /* Edit button */
    .edit-btn{
      background:transparent;
      border:none;
      cursor:pointer;
      font-size:16px;
      color:#007bff;
    }
    .edit-btn:hover{color:#0056b3;}

    /* Aging badge */
    .badge{
      display:inline-block;
      min-width:48px;
      text-align:center;
      padding:4px 8px;
      border-radius:12px;
      font-weight:600;
      color:#fff;
    }

    /* Popup modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
      animation:fade .2s ease;
    }
    .modal-content{
      background:#fff;
      padding:24px;
      border-radius:10px;
      width:400px;
      max-width:90%;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      animation:zoom .25s ease;
    }
    .modal-content h3{margin:0 0 16px;font-size:18px;}

    .modal-content input{
      width:100%;
      padding:10px;
      margin-bottom:12px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:14px;
    }

    .modal-actions{text-align:right;margin-top:12px;}
    .modal-actions button{
      padding:8px 14px;
      font-size:14px;
      margin-left:8px;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    .save-btn{background:#28a745;color:#fff;}
    .cancel-btn{background:#ccc;color:#333;}

    @keyframes fade{from{opacity:0;}to{opacity:1;}}
    @keyframes zoom{from{transform:scale(.8);}to{transform:scale(1);}}
  </style>
</head>

<body>
  <h2>Dashboard Google Sheet</h2>
  <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm..." />

  <table id="dataTable">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- ======= Popup form ======= -->
  <div id="popupForm" class="modal-overlay">
    <div class="modal-content">
      <h3>Ch·ªânh s·ª≠a d√≤ng</h3>
      <div id="popupFields"></div>
      <div class="modal-actions">
        <button class="cancel-btn" onclick="closePopup()">Hu·ª∑</button>
        <button class="save-btn" onclick="submitPopup()">L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- ========== ü§ñ SCRIPT ========== -->
  <script>
    /************** 1. CONFIG **************/
    const url = 'https://lzdcemanagement.phuonghoangcao1703.workers.dev/';
    const DATE_FIELD = 'Date received';   // t√™n c·ªôt ng√†y nh·∫≠n tr√™n Google Sheet

    /************** 2. GLOBAL STATE **************/
    let originalData = [];   // d·ªØ li·ªáu g·ªëc t·ª´ API
    let currentItem  = {};   // item ƒëang m·ªü popup ch·ªânh s·ª≠a

    /************** 3. FETCH + RENDER TABLE **************/
    fetch(url)
      .then(r => r.json())
      .then(data => {
        originalData = normalizeData(data);
        renderTable(originalData);
      });

    function normalizeData(data){
      return Array.isArray(data) ? data : [data];
    }

    /** T√çNH S·ªê NG√ÄY T·ªíN ƒê·ªåNG */
    function calculateAging(dateStr){
      const received = new Date(dateStr);
      const today    = new Date();
      const diff     = Math.floor((today - received) / (1000*60*60*24));
      return isFinite(diff) && diff >= 0 ? diff : '-';
    }

    /** CH·ªåN M√ÄU THEO S·ªê NG√ÄY */
    function getAgingColor(days){
      if(days === '-')            return '#6c757d';    // x√°m (kh√¥ng h·ª£p l·ªá)
      if(days <= 3)               return '#22c55e';    // xanh
      if(days <= 7)               return '#eab308';    // v√†ng
      return '#ef4444';                             // ƒë·ªè
    }

    /** RENDER TABLE */
    function renderTable(data){
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      thead.innerHTML = ''; tbody.innerHTML = '';
      if(!data.length) return;

      /* ----- Header ----- */
      const keys = Object.keys(data[0]);
      const headerRow = document.createElement('tr');

      const thAction = document.createElement('th');
      thAction.textContent = '‚úèÔ∏è';
      headerRow.appendChild(thAction);

      keys.forEach(k=>{
        const th = document.createElement('th');
        th.textContent = k;
        headerRow.appendChild(th);
      });

      // Th√™m c·ªôt Aging backlog
      const thAging = document.createElement('th');
      thAging.textContent = 'Aging backlog';
      headerRow.appendChild(thAging);

      thead.appendChild(headerRow);

      /* ----- Body ----- */
      data.forEach(item=>{
        const tr = document.createElement('tr');

        // Edit button
        const btnTd = document.createElement('td');
        const btn   = document.createElement('button');
        btn.className = 'edit-btn';
        btn.textContent = '‚úèÔ∏è';
        btn.title = 'Ch·ªânh s·ª≠a d√≤ng n√†y';
        btn.onclick = ()=>showPopup(item);
        btnTd.appendChild(btn);
        tr.appendChild(btnTd);

        // Data cells
        keys.forEach(k=>{
          const td = document.createElement('td');
          td.textContent = item[k];
          tr.appendChild(td);
        });

        // Aging backlog cell
        const agingDays = calculateAging(item[DATE_FIELD]);
        const tdAging   = document.createElement('td');
        const badge     = document.createElement('span');
        badge.className = 'badge';
        badge.style.background = getAgingColor(agingDays);
        badge.textContent = agingDays === '-' ? '-' : `${agingDays}d`;
        tdAging.appendChild(badge);
        tr.appendChild(tdAging);

        tbody.appendChild(tr);
      });
    }

    /************** 4. POPUP EDIT **************/
    function showPopup(item){
      currentItem = item;
      const container = document.getElementById('popupFields');
      container.innerHTML = '';

      Object.keys(item).forEach(k=>{
        if(k === '_row') return;
        const input = document.createElement('input');
        input.value = item[k];
        input.dataset.key = k;
        container.appendChild(input);
      });
      document.getElementById('popupForm').style.display = 'flex';
    }

    function closePopup(){
      document.getElementById('popupForm').style.display = 'none';
    }

    function submitPopup(){
      const inputs = document.querySelectorAll('#popupFields input');
      const updated = { _row: currentItem._row };
      inputs.forEach(i=> updated[i.dataset.key] = i.value );

      fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(updated)
      })
      .then(r=>r.text())
      .then(res=>{
        alert(res);
        closePopup();
        // reload
        fetch(url)
          .then(r=>r.json())
          .then(data=>{
            originalData = normalizeData(data);
            renderTable(originalData);
          });
      });
    }

    /************** 5. SEARCH FILTER **************/
    document.getElementById('searchInput')
            .addEventListener('input', e=>{
      const kw = e.target.value.toLowerCase();
      const filtered = originalData.filter(row=>
        Object.values(row).some(v=>
          typeof v === 'string' && v.toLowerCase().includes(kw)
        )
      );
      renderTable(filtered);
    });
  </script>
</body>
</html>
